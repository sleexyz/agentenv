# Portable Dev Environments

> Your tools, your config, your skills — layered on top of any project.

## Three Primitives

agentenv composes three independent layers. Each is optional.

### 1. Nix Store (golden volume)

Package cache at `/nix`. Contains project devshell packages AND personal tools (via nix profile). COW-cloned from a golden ext4 image in ~2ms. Promoted back on exit (accumulates store paths). Rebuildable, disposable.

### 2. Dev Environment (profile directory)

A directory of files — dotfiles, editor config, skills, memory. Mounted via VirtioFS at `/root/profile`. Live-editable from the host.

Has an `activate.sh` that symlinks files into place. Pure symlinks, no package management.

May contain a `flake.nix` that declares personal tools — but those packages go into the nix store, not here.

### 3. DevShell (project flake)

Packages on PATH for a specific project. Declared in the project's `flake.nix`, instantiated by `nix develop`. Ephemeral, per-project.

## How they compose

```
                    ┌─────────────────────────────┐
                    │  Dev Environment (optional)  │  ~/config → /root/profile
                    │  activate.sh: symlinks only  │  dotfiles, skills
                    ├─────────────────────────────┤
nix develop PATH →  │  DevShell (project)          │  project flake.nix
                    ├─────────────────────────────┤
~/.nix-profile/bin → │  Personal Tools (nix profile)│  declared in dev env flake
                    ├─────────────────────────────┤
                    │  Nix Store (golden volume)   │  /nix, COW-cloned
                    └─────────────────────────────┘
```

PATH inside the container = devshell packages + `~/.nix-profile/bin` (personal tools) + base paths.

`nix develop` already includes `~/.nix-profile/bin` in PATH, so personal tools and project tools coexist without explicit composition.

## Boot sequence

```
agentenv .
  1. APFS COW clone golden volume → /nix                    (2ms)
  2. Mount dev env: ~/config → /root/profile                (VirtioFS)
  3. Mount project: cwd → /work                             (VirtioFS)
  4. Entrypoint:
     a. Seed /nix if empty                                  (first boot only)
     b. If profile has flake: nix profile install tools     (first boot, then cached)
     c. If profile has activate.sh: source it               (symlinks dotfiles)
     d. nix develop /work --command zsh                     (or bash if no zsh)
  5. On exit: promote golden volume                         (persist nix store)
```

First boot: ~3-4 min (downloads personal tools). Second boot: ~2.8s (cached).

## The Profile Directory

A profile is any directory with an `activate.sh` at its root:

```
~/config/
  activate.sh           # symlinks dotfiles + skills into place
  .config/
    nvim/               # neovim config (init.vim + lua/)
    zsh/                # zsh config (.zshrc, .zshenv)
    helix/              # helix config
    git/                # git ignore
  .tmux.conf            # tmux config
  skills/               # Claude skills
  flake.nix             # declares personal tools (buildEnv)
```

### activate.sh

Pure symlinks. No package management, no build steps.

```bash
#!/bin/sh
PROFILE_DIR="$(cd "$(dirname "$0")" && pwd)"

mkdir -p ~/.config
ln -sfn "$PROFILE_DIR/.config/nvim" ~/.config/nvim
ln -sfn "$PROFILE_DIR/.config/zsh" ~/.config/zsh
ln -sfn "$PROFILE_DIR/.config/git" ~/.config/git
ln -sfn "$PROFILE_DIR/.tmux.conf" ~/.tmux.conf

# Claude skills
mkdir -p ~/.claude/skills
for skill in "$PROFILE_DIR/skills"/*/; do
  [ -d "$skill" ] || continue
  ln -sfn "$skill" ~/.claude/skills/"$(basename "$skill")"
done
```

### Personal tools declaration

In the profile's `flake.nix`, as a simple `packages` output:

```nix
packages.aarch64-linux.portable = let
  pkgs = nixpkgs.legacyPackages.aarch64-linux;
in pkgs.buildEnv {
  name = "personal-tools";
  paths = with pkgs; [ zsh neovim tmux ripgrep fd fzf jq eza zoxide ... ];
};
```

Not home-manager. Just a package list. The entrypoint runs `nix profile install` from this on first boot.

### Dotfiles are standalone

Dotfiles are plain files, not generated by home-manager. Write a `.zshrc` that sets up your shell. Write a `.tmux.conf` with your keybinds. The dev environment is just files.

## agentenv integration

```bash
agentenv .                          # dev shell with personal profile (~/config)
agentenv --profile ~/other .       # override profile directory
agentenv --no-profile .            # bare dev shell, no profile
```

Profile defaults to `~/config`. `--no-profile` skips mounting the profile (no dotfiles, no skills), but personal tools remain available if previously installed into the golden volume.

## What's NOT in the profile

- Project-specific packages (those come from the project's flake.nix devShell)
- Project-specific config (that's in the project repo)
- Secrets (SSH keys, API tokens — separate concern)
- macOS-specific services

## What could layer on top (future)

- **Home-manager:** Could manage the dev environment declaratively. Optional.
- **Remote transport:** SSHFS, Tailscale, nix build. Same primitives, different mount.
- **Agent dispatch:** Same dev environment, shipped to a remote machine.
