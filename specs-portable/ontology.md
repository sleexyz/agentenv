# agentenv Ontology

Three independent primitives, each optional:

## 1. Nix Store (golden volume)

**What:** Package cache. All nix packages live here — devshell packages, personal tool profiles, base image seed. The ext4 image at `/nix`, cloned via APFS COW.

**Properties:**
- Rebuildable, disposable — blow it away and rebuild
- Promoted back to golden on container exit (accumulates)
- Contains nix profiles (personal tools installed via `nix profile install`)

**Not:** Your files. Not your dotfiles, not your skills, not your memory.

## 2. Dev Environment (optional, mounted via VirtioFS)

**What:** A directory of files. Your HOME stuff — dotfiles, editor config, skills, memory. Mounted into the container, live-editable from the host.

**Properties:**
- Just files. No nix required.
- Has an `activate.sh` that symlinks files into the right places
- May optionally contain a flake.nix that declares personal tools (but the packages go into the nix store, not here)
- Portable — mount it anywhere and `activate.sh` wires it up

**Example:** `~/config` with `.config/nvim/`, `.config/zsh/`, `.config/git/`, `.tmux.conf`, `skills/`, `activate.sh`

**Dotfiles are standalone plain files.** Not generated by home-manager, not dependent on nix store paths. If you want prezto in zsh, write a `.zshrc` that sets it up. If you want catppuccin in tmux, write a `.tmux.conf` that loads it. The dev environment is just files.

**activate.sh contract:** Pure symlinks. No package management, no build steps.

```sh
#!/bin/sh
PROFILE_DIR="$(cd "$(dirname "$0")" && pwd)"
mkdir -p ~/.config
ln -sfn "$PROFILE_DIR/.config/nvim" ~/.config/nvim
ln -sfn "$PROFILE_DIR/.config/zsh" ~/.config/zsh
ln -sfn "$PROFILE_DIR/.tmux.conf" ~/.tmux.conf
# ... more symlinks
```

## 3. DevShell (ephemeral, per-project)

**What:** Packages on PATH for a specific project. Declared in the project's `flake.nix`, instantiated by `nix develop`. Ephemeral — not persisted, re-evaluated each boot.

**Properties:**
- Project-specific tools (compilers, linters, SDKs)
- Declared in the project repo
- `nix develop` sets PATH to include these packages

## How they compose

```
                    ┌─────────────────────────────┐
                    │  Dev Environment (optional)  │  ~/config → /root/profile
                    │  activate.sh: symlinks only  │  dotfiles, skills, memory
                    ├─────────────────────────────┤
nix develop PATH →  │  DevShell (project)          │  project flake.nix
                    ├─────────────────────────────┤
~/.nix-profile/bin → │  Personal Tools (nix profile)│  declared in dev env flake
                    ├─────────────────────────────┤
                    │  Nix Store (golden volume)   │  /nix, COW-cloned
                    └─────────────────────────────┘
```

PATH inside the container = devshell packages + `~/.nix-profile/bin` (personal tools) + base paths.

`nix develop` already includes `~/.nix-profile/bin` in PATH, so personal tools and project tools coexist without explicit composition.

## Boot sequence

```
agentenv .
  1. APFS COW clone golden volume → /nix                    (2ms)
  2. Mount dev env: ~/config → /root/profile                (VirtioFS)
  3. Mount project: cwd → /work                             (VirtioFS)
  4. Entrypoint:
     a. Seed /nix if empty                                  (first boot only)
     b. If profile has flake: nix profile install personal tools  (first boot, then cached)
     c. If profile has activate.sh: source it               (symlinks dotfiles)
     d. nix develop /work --command zsh                     (or bash if no zsh)
  5. On exit: promote golden volume                         (persist nix store)
```

## Where personal tools are declared

In the dev environment's `flake.nix`, as a simple `packages` output:

```nix
# ~/config/flake.nix (alongside the existing darwin config)
packages.aarch64-linux.portable = pkgs.buildEnv {
  name = "personal-tools";
  paths = with pkgs; [ zsh neovim tmux ripgrep fd fzf jq eza zoxide ... ];
};
```

Not home-manager. Just a package list. Home-manager is a future optional layer.

## What's NOT a primitive (but could layer on top)

- **Home-manager:** Could manage the dev environment declaratively. Optional.
- **Remote transport:** SSHFS, Tailscale, nix build. Same primitives, different mount mechanism.
- **Agent dispatch:** Same dev environment, shipped to a remote machine.
